name: TruffleHog Git Scan - JSON Export

on:
  push:
    branches:
      - '**'
  workflow_dispatch:

jobs:
  trufflehog-scan:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout Code (Full History for Git Scanning)
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # 2. Create reports directory
      - name: Create reports directory
        run: mkdir -p reports

      # 3. Run TruffleHog Git Scan (Full History)
      - name: Run TruffleHog Git Scan (NDJSON output)
        run: |
          echo "Running TruffleHog Git scan (full history)..."
          docker run --rm -v $PWD:/pwd ghcr.io/trufflesecurity/trufflehog:latest \
            git file:///pwd --json > reports/trufflehog-raw.ndjson || true

      # 4. Convert NDJSON â†’ JSON Array
      - name: Convert NDJSON to JSON Array
        run: |
          echo "Converting TruffleHog NDJSON to JSON array..."
          jq -s '.' reports/trufflehog-raw.ndjson > reports/trufflehog-scan.json

      # 5. Upload JSON report as artifact (downloadable)
      - name: Upload TruffleHog JSON Report
        uses: actions/upload-artifact@v4
        with:
          name: trufflehog-scan-report
          path: reports/trufflehog-scan.json

      # 6. Upload NDJSON (Optional - Raw Format)
      - name: Upload Raw NDJSON Report
        uses: actions/upload-artifact@v4
        with:
          name: trufflehog-raw-report
          path: reports/trufflehog-raw.ndjson
